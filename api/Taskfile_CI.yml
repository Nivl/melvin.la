version: "3"

tasks:
  # This is only used by the CI, for the production build check the Dockerfile
  build: CGO_ENABLED=0 go build -v -o ./bin/api github.com/Nivl/melvin.la/api/cmd/api

  migrate:
    cmds:
      - migrate -path database/migrations -database ${API_POSTGRES_URL} {{.CLI_ARGS}}

  lint-migrations-and-codegen:
    cmds:
      - pg_dump -d ${API_POSTGRES_URL} -C | awk 'RS="";/(CREATE TABLE|INDEX)|(ALTER TABLE)[^;]*;/' > database/schemas/public.sql
      - git diff --exit-code
      - go tool github.com/daveshanley/vacuum bundle -p openapi/ openapi/openapi.yml internal/gen/openapi.yml
      - git diff --exit-code
      - go generate ./...
      - git diff --exit-code
      - go mod tidy
      - git diff --exit-code

  lint:
    cmds:
      - golangci-lint run ./...
      - go tool github.com/daveshanley/vacuum lint internal/gen/openapi.yml -q -d -n warn
      - go mod tidy
      - git diff --exit-code

  test:
    - mkdir -p {{.RESULTS_DIR}}
    - CGO_ENABLED=1 gotestsum --jsonfile="{{.RESULTS_DIR}}"/results.json -- -race -timeout 3m -coverprofile coverage.txt ./...
